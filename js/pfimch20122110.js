const merchInfo = [
	{
		SKU: 'AWTSHT1604Je',
		vidx: '2',
		vid: "CW2",
		SKUvid: 'AWTSHT1604Je-CW2',
		ledes: ['In Black. For that #oneofakind person!'],
		images: [{
			url: '/g/merch/wc3.jpg'
		}, {
			url: '/people/ooak/sl01.jpg'
		}, {
			url: '/people/ooak/sl02.jpg'
		}, {
			url: '/g/merch/wc1.jpg'
		}, {
			url: '/g/merch/wc4.jpg'
		}]
    },
	{
		SKU: 'AWTSHT1604Je',
		vidx: '1',
		vid: "CW1",
		SKUvid: 'AWTSHT1604Je-CW1',
		ledes: ['In White. A #oneofakind T-shirt.'],
		images: [{
			url: '/g/merch/wc2.jpg'
		}]
    },
	{
		SKU: 'OVTPSH1501Pa',
		ledes: [''],
		images: [{
			url: '/g/merch/sovr.jpg'
		}]
    },
	{
		SKU: 'OVTPLO1501Pa',
		ledes: [''],
		images: [{
			url: '/blog/FlorDuomo.jpg'
		}, {
			url: '/g/merch/lovr1.jpg'
		}, {
			url: '/g/merch/lovr2.jpg'
		}]
    },
	{
		SKU: 'TRPZTP1807Pa',
		ledes: [''],
		images: [{
			url: '/g/merch/payara2.jpg'
		}]
    },
	{
		SKU: 'MDRSTP1606PP',
		ledes: [''],
		images: [{
			url: '/g/merch/mdrs.jpg'
		}]
    },
	{
		SKU: 'JULITP1501Pa',
		ledes: [''],
		images: [{
			url: '/g/merch/rvk1.jpg'
		}]
    },
	{
		SKU: 'SARITP1501Pa',
		ledes: [''],
		images: [{
			url: '/g/merch/sari1.jpg'
		}, {
			url: '/g/merch/sari2.jpg'
		}]
    },
	{
		SKU: 'LNKFTN1501Ja',
		ledes: [''],
		images: [{
			url: '/products/holydaysreboot/Kaftan.jpg'
		}, {
			url: '/g/aw/HDRKaftan1AW.jpg'
		}]
    },
	{
		SKU: 'LOTSDR1501Ja',
		ledes: [''],
		images: [{
			url: '/products/holydaysreboot/Lotus.jpg'
		}, {
			url: '/g/merch/kmlm.jpg'
		}]
    },
	{
		SKU: 'NKSHDR1501Ta',
		ledes: [''],
		images: [{
			url: '/look/ramp/j201.jpg'
		}, {
			url: '/people/tmribzSq.jpg'
		}, {
			url: '/g/merch/tmri.jpg'
		}]
	}
	,
	{
		SKU: 'KLGTLY1601Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/LightLayer.jpg'
		}]
    },
	{
		SKU: 'KGYPST1601Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/GypsySet.jpg'
		}, {
			url: '/g/merch/gypsy.jpg'
		}]
    },
	{
		SKU: 'KRAJPT1601Kh',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/RajPantsSq2.jpg'
		}]
    },
	{
		SKU: 'FAIRST2011Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/FairySet.jpg'
		}]
    },
	{
		SKU: 'KBALPA1601Vo',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/Balloon.jpg'
		}]
    },
	{
		SKU: 'KRAJKT1601Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/RajKurta.jpg'
		}, {
			url: '/products/itsmagic/RajBoy.jpg'
		}, {
			url: '/g/merch/royal1.jpg'
		}, {
			url: '/g/merch/royal2.jpg'
		}]
    },
	{
		SKU: 'YUVRTC1601Rv',
		ledes: [''],
		images: [{
			url: '/g/merch/prince.jpg'
		}]
    },
	{
		SKU: 'HLFPNT1601Kh',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/HalfPant.jpg'
		}]
    },
	{
		SKU: 'KIDIKI1501Vi',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/Kidikini.jpg'
		}]
    },
	{
		SKU: 'PRNCDR1501Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/Princess.jpg'
		}, {
			url: '/g/merch/princess.jpg'
		}]
    },
	{
		SKU: 'KWAVDR1601Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/Wave.jpg'
		}, {
			url: '/g/merch/wave.jpg'
		}]
    },
	{
		SKU: 'KDHRDR1601Rv',
		ledes: [''],
		images: [{
			url: '/products/itsmagic/Dhara.jpg'
		}]
    },
	{
		SKU: 'HLNDRS1505PT',
		ledes: [''],
		images: [{
			url: '/look/moods/cs/helena.jpg'
		}]
    },
	{
		SKU: 'JLTDRS1505PT',
		ledes: [''],
		images: [{
			url: '/look/moods/cs/juliet.jpg'
		}]
    },
	{
		SKU: 'BKLLTS1505Je',
		ledes: [''],
		images: [{
			url: '/look/moods/cs/tamora.jpg'
		}]
    },
	{
		SKU: 'NKSHMU1501PP',
		ledes: ["Full length #oneofakind skirt for all ages and sizes!"],
		images: [{
			url: '/look/friends/1.jpg'
		}]
    },
	{
		SKU: 'NKSHMD1501PP',
		ledes: ["#oneofakind skirt for all ages and sizes!"],
		images: [{
			url: '/people/mmib.jpg'
		}, {
			url: '/people/slkb.jpg'
		}, {
			url: '/people/ibgirl.jpg'
		}, {
			url: '/look/friends/2.jpg'
		}, {
			url: '/g/look/nkshofstp.jpg'
		}]
    },
	{
		SKU: 'NKSHMI1501PP',
		ledes: ["#oneofakind mini skirt for all ages and sizes!"],
		images: [{
			url: '/people/EricaNaksha1.jpg'
		}]
    },
	{
		SKU: 'NKSHMC1512PP',
		ledes: ["#oneofakind micro skirt for all ages and sizes!"],
		images: [{
			url: '/people/nmnibz.jpg'
		}]
    },
	{
		SKU: 'FACEMK2005Ta',
		ledes: ["#oneofakind facemask to keep you safe in style and comfort"],
		images: [{
			url: '/people/nfm01.jpg'
		}, {
			url: '/people/nfm02.jpg'
		}, {
			url: '/people/nfm03.jpg'
		}, {
			url: '/look/friends/gg-pink.jpg'
		}, {
			url: '/look/friends/gg-aqua.jpg'
		}, {
			url: '/look/friends/gg-ind-1.jpg'
		}]
    },
	{
		SKU: 'DPDYSF1501PT',
		ledes: ["A gorgeous example of the Tangail Weavers' Craft"],
		images: [{
			url: '/products/scarves/TurbanMood.jpg'
		}, {
			url: '/products/scarves/ShawlMood.jpg'
		}, {
			url: '/products/scarves/LinedUpLtd.jpg'
		}, {
			url: '/people/nmnibz.jpg'
		}, {
			url: '/g/look/look01.jpg'
		}]
    },
	{
		SKU: 'KAGTIE1601Kh',
		ledes: ['Artsy, hand-woven, hand-crafted Neckwear', 'For the gentleman of refined taste - a two-tone khadi tie with a border of treasured tangail'],
		images: [{
			url: '/products/men/kagera/kag1.jpg'
		}, {
			url: '/products/men/kagera/kag2.jpg'
		}, {
			url: '/products/men/kagera/kag3.jpg'
		}]
    },
	{
		SKU: 'CHMPGN1501JL',
		ledes: ['The perfect gift bag for that exclusive vintage'],
		images: [{
			url: '/products/home/CBCCMD.jpg'
		}, {
			url: '/products/home/CBCGMD.jpg'
		}, {
			url: '/products/home/CBMBMD.jpg'
		}]
    },
	{
		SKU: 'TRPZTP1807Kh',
		ledes: [''],
		images: [{
			url: '/look/friends/tt.jpg'
		}]
    },
	{
		SKU: 'CRPTOP1805Kh',
		ledes: ['Basic summer top'],
		images: [{
			url: '/products/happyeveryday/mood/mch-1.jpg'
		}]
    },
	{
		SKU: 'VAMPAL1708Kh',
		ledes: ['Handwoven khadi to lighten up your summers'],
		images: [{
			url: '/products/happyeveryday/mood/mch-2.jpg'
		}, {
			url: '/products/happyeveryday/mood/mch-7.jpg'
		}]
    },
	{
		SKU: 'OVTPLO1501Vo',
		ledes: ['Light breezy jacket for spring'],
		images: [{
			url: '/products/happyeveryday/mood/mch-3.jpg'
		}, {
			url: '/blog/joyofcolour/2.jpg'
		}]
    },
	{
		SKU: 'BERMPA1609Kh',
		ledes: ['Casual pants to work and lounge in'],
		images: [{
			url: '/products/happyeveryday/mood/mch-4.jpg'
		}]
    },
	{
		SKU: 'LTSDSL1501Kh',
		ledes: ['A dress that works from dawn to dusk'],
		images: [{
			url: '/products/happyeveryday/mood/mch-5.jpg'
		}]
    },
	{
		SKU: 'BALLPA1501Vo',
		ledes: ['Everyday basics for every mood'],
		images: [{
			url: '/products/happyeveryday/mood/mch-6.jpg'
		}]
    }
];

function getRandomIdx(arr) {
	return Math.floor(Math.random() * arr.length);
}

function createPageSet(pages) {
	return {
		pages: pages,
		includes: function (page, key) {
			var url = page[key];
			if (url === undefined) {
				return false;
			}
			return this.select(key, url) !== undefined;
		},
		includesImg: function (page) {
			var url = page.imageURL;
			if (url === undefined) {
				return false;
			}
			if (this.select('imageURL', url) !== undefined) {
				return true;
			}
			var imgs = page.images;
			if (imgs === undefined) {
				return false;
			}
			for (var i = 0; i < imgs.length; i++) {
				url = imgs[i].url;
				if (this.select('imageURL', url) !== null) {
					return true;
				}
			}
			return false;
		},
		filter: function (fn) {
			return createPageSet(pages.filter(fn));
		},
		select: function (key, val) {
			return this.pages.find(function (page) {
				return page[key] === val
			});
		}
	}
}

function createMIPageSet() {
	var pages = JSON.parse(JSON.stringify(merchInfo));
	var catalog = pfiavG.catalog;
	for (var i = 0; i < pages.length; i++) {
		var item = pages[i];
		item.title = catalog[item.SKU].name;
		item.url = catalog[item.SKU].url;
	}
	return createPageSet(pages);
}

function createPageIndex(page) {
	return {
		page: page,
		included: createPageSet([page]),
		mentioned: createPageSet([]),
		miPageSet: createMIPageSet(),

		createFeatures: function () {
			var pageSel = createPageSelector(this.miPageSet);
			var merch = pageSel.selectMerch(2);
			this.included = createPageSet(this.included.pages.concat(merch));
			var stories = pageSel.selectFeatures(2);
			this.included = createPageSet(this.included.pages.concat(stories));
			return createRelated("Features", merch.concat(stories), [1, 4, 7, 10]);
		},
		createShopCard: function () {
			var pageSel = createPageSelector(this.miPageSet);
			var merch = pageSel.selectMerch(1);
			this.included = createPageSet(this.included.pages.concat(merch));
			return merch[0].createCard();
		}
	}
}

function createNUSampler(total, items, sample, itemkey) {
	return {
		itemkey: itemkey,
		total: total,
		items: items,
		sample: sample,
		sampleOne: function () {
			var rndWeight = Math.floor(Math.random() * this.total);
			var cumWeight = 0;
			for (var i = 0; i < this.items.length; i++) {
				var item = this.items[i];
				cumWeight += item.weight;
				if (rndWeight < cumWeight) {
					var newitems = this.items.slice(0, i).concat(this.items.slice(i + 1))
					var newsample = this.sample.concat([item]);
					var newtotal = this.total - item.weight;
					return createNUSampler(newtotal, newitems, newsample, this.itemkey);
				}
			}
			return this;
		},
		sampleN: function (n) {
			var sam = this;
			for (var i = 0; i < n; i++) {
				sam = sam.sampleOne();
			}
			return sam;
		},
		filter: function (keys) {
			var itms = this.items.filter(i => keys.includes(i[this.itemkey]));
			var smpl = this.sample.filter(i => keys.includes(i[this.itemkey]));
			var cum = 0;
			itms.forEach(i => cum += i.weight);
			return createNUSampler(cum, itms, smpl, this.itemkey);
		}
	};
}

function createItemSample(sku, weight) {
	return {
		SKU: sku,
		weight: weight
	};
}

function createMerchandisingSampler(merchSKUs, merchSections, sectionWeights) {
	var merchWeights = {
		AWTSHT1604Je: 30,
		NKSHMD1501PP: 30,
		FACEMK2005Ta: 20
	};
	var items = merchSKUs.flatMap((skulist, idx) => skulist.map(sku => createItemSample(sku, merchWeights[sku] !== undefined ? merchWeights[sku] : sectionWeights[idx])));
	var cum = 0;
	items.forEach(i => cum += i.weight);
	return createNUSampler(cum, items, [], 'SKU');
}

function createStorySample(item, weight) {
	var clone = JSON.parse(JSON.stringify(item));
	clone.weight = weight;
	return clone;
}

function createStorySampler(all) {
	var cum = 0;
	all.forEach(i => cum += i.weight);
	return createNUSampler(cum, all, [], 'url');
}

function createPageSelector(mips) {
	var lineMerchSKUs = [
    ["AWTSHT1604Je"],
    ["OVTPSH1501Pa", "OVTPLO1501Pa", "TRPZTP1807Pa", "MDRSTP1606PP", "SARITP1501Pa", "LNKFTN1501Ja", "LOTSDR1501Ja", "NKSHDR1501Ta", "NKSHMU1501PP", "NKSHMD1501PP", "JULITP1501Pa", "NKSHMC1512PP", "FACEMK2005Ta"],
    ["KLGTLY1601Rv", "KGYPST1601Rv", "KRAJPT1601Kh", "FAIRST2011Rv", "KBALPA1601Vo", "KRAJKT1601Rv", "YUVRTC1601Rv", "HLFPNT1601Kh", "KIDIKI1501Vi", "PRNCDR1501Rv", "KWAVDR1601Rv", "KDHRDR1601Rv"],
    ["HLNDRS1505PT", "JLTDRS1505PT", "BKLLTS1505Je"],
    ["TRPZTP1807Kh", "CRPTOP1805Kh", "VAMPAL1708Kh", "OVTPLO1501Vo", "BERMPA1609Kh", "LTSDSL1501Kh", "BALLPA1501Vo"],
    ["DPDYSF1501PT"]
	];
	var lineMerchSections = [
		{
			"title": "Woven Canvas",
			"url": "/products/wovencanvas/shop.html"
		},
		{
			"title": "Art Wear",
			"url": "/products/artwear/shop.html"
		},
		{
			"title": "It's Magic",
			"url": "/products/itsmagic/shop.html"
		},
		{
			"title": "Ce Soir",
			"url": "/products/night/shop.html"
		},
		{
			"title": "Happy Everyday",
			"url": "/products/happyeveryday/shop.html"
		},
		{
			"title": "Extras",
			"url": "/products/xtras/shop.html"
		}
	];
	var lineMerchWeights = [3, 3, 2, 2, 1, 2];

	var merchSKUs = lineMerchSKUs.flat();
	var sections = [atelier, origin, about, buzz, archives, lotm, moods, ramp, clients];
	var weights = [3, 5, 2, 2, 1, 3, 1, 2, 5];
	var allstories = sections.flatMap((sec, secidx) => sec.sub.map(pg => createStorySample(pg, weights[secidx])));
	return {
		sections: sections,
		allstories: allstories,
		miPageSet: mips,
		merchSKUs: merchSKUs,
		merchSKUSampler: createMerchandisingSampler(lineMerchSKUs, lineMerchSections, lineMerchWeights),
		storySampler: createStorySampler(allstories),
		filterStories: function () {
			var blacklist = pfiavG.pageIdx.included;
			return this.allstories.filter(function (page) {
				return !blacklist.includes(page, 'url') && !blacklist.includesImg(page);
			});
		},
		selectURLs: function (fltS, nStories) {
			var sampler = this.storySampler.filter(fltS.map(pg => pg.url));
			return sampler.sampleN(nStories).sample.map(s => s.url);
		},
		findStorySection: function (url) {
			var secIdx = this.sections.findIndex(sec => sec.sub.find(pg => pg.url === url) !== undefined);
			return this.sections[secIdx];
		},
		selectFeatures: function (nStories) {
			var fltS = this.filterStories();
			var fltURLs = this.selectURLs(fltS, nStories);
			var res = [];
			for (var i = 0; i < fltURLs.length; i++) {
				let url = fltURLs[i];
				var sel = this.allstories.find(pg => pg.url === url);
				res.push(createStoryRef(this.findStorySection(url), sel));
			}
			return res;
		},
		findMerchSection: function (sku) {
			var lineIdx = lineMerchSKUs.findIndex(skulist => skulist.includes(sku));
			return lineMerchSections[lineIdx];
		},
		filterMerchPages: function () {
			var blacklist = pfiavG.pageIdx.included;
			return this.miPageSet.filter(function (page) {
				return !blacklist.includes(page, 'url') && !blacklist.includesImg(page) && !blacklist.includes(page, 'SKU');
			});
		},
		selectSKUs: function (fltMI, nMerch) {
			var fltSKUs = this.merchSKUs.filter(sku => fltMI.select('SKU', sku) !== undefined);
			var sampler = this.merchSKUSampler.filter(fltSKUs);
			return sampler.sampleN(nMerch).sample.map(s => s.SKU);
		},
		selectMerch: function (nMerch) {
			var fltMI = this.filterMerchPages();
			var fltSKUs = this.selectSKUs(fltMI, nMerch);
			var res = [];
			for (var i = 0; i < fltSKUs.length; i++) {
				var sku = fltSKUs[i];
				var sel = fltMI.select('SKU', sku);
				var img = sel.images[getRandomIdx(sel.images)];
				sel.imageURL = img.url;
				var ref = createMerchandisingRef(sel, this.findMerchSection(sku), nMerch === 1);
				ref.setRandLede();
				res.push(ref);
			}
			return res;
		},
	}
}

function createProductCard(sku, title, url, imageURL, lede, isSq, section, vid) {
	var res = '<div class="card mb-2 px-1 px-md-2">';
	if (isSq) {
		res += '<div class="embed-responsive embed-responsive-1by1">';
		res += '<img src="' + imageURL + '" alt="' + title + '" class="embed-responsive-item" style="object-fit: cover">';
		res += '</div>';
	} else {
		res += '<div class="card-img">'
		res += '<img src="' + imageURL + '" alt="' + title + '" class="img-fluid card-img-top card-img-front">';
		res += '</div>';
	}
	res += '<div class="card-body px-0 pt-6 pb-4">';
	if (section === undefined) {
		res += '<div class="card-subtitle mb-1"><span class="sc-item" data-field="price" data-vsku="' + sku + '"' + (vid === undefined ? '' : ' data-vid="' + vid + '"') + '></span></div>';
		res += '<h6 class="card-title mb-2">' + title + '<a  href="' + url + '"><i class="fa fa-arrow-right ml-2"></i></a></h6>';
	} else {
		res += '<div class="card-subtitle mb-1"><a class="text-muted" href="' + section.url + '">' + section.title + '</a></div>';
		res += '<h6 class="card-title mb-2">' + title + '<a  href="' + url + '"><i class="fa fa-arrow-right ml-2"></i></a></h6>';
		res += '<p class="mb-1"><span class="sc-item" data-field="price" data-vsku="' + sku + '"' + (vid === undefined ? '' : ' data-vid="' + vid + '"') + '></span></p>'
	}
	if (lede !== null) {
		res += '<p class="mb-1">' + lede + '</p>';
	}
	res += '</div></div>';
	return res;
}

function createProductRef(product) {
	return {
		title: product.name,
		url: product.url,
		imageURL: null,
		setImg(imgurl) {
			this.imageURL = imgurl;
		},
		createCard: function () {
			return createProductCard(product.sku, this.title, this.url, this.imageURL, null, false, undefined);
		}
	};
}

function createMerchandisingRef(item, section, isCompact) {
	var url = (item.vidx === undefined) ? item.url : item.url + "?v=" + item.vidx;
	return {
		SKU: item.SKU,
		vidx: item.vidx,
		imageURL: item.imageURL,
		url: url,
		lede: null,
		setRandImg: function () {
			this.setImg(getRandomIdx(item.images));
			this.setRandLede();
		},
		setImg(idx) {
			this.imageURL = item.images[idx].url;
		},
		setRandLede() {
			this.lede = item.ledes[getRandomIdx(item.ledes)];
		},
		createCard: function () {
			if (isCompact) {
				return createProductCard(this.SKU, item.title, this.url, this.imageURL, null, true, section, item.vid);
			} else {
				return createProductCard(this.SKU, item.title, this.url, this.imageURL, this.lede, true, section, item.vid);
			}
		}
	}
}

function createStoryRef(s, itm) {
	return {
		sec: s,
		sel: itm,
		title: itm.title,
		url: itm.url,
		imageURL: itm.imageURL,
		imageHTML: itm.imageHTML,
		imageScript: itm.imageScript,
		lede: itm.lede,
		createCard: function () {
			var section = this.sec;
			var item = this.sel;
			var res = '<div class="card mb-2 px-1 px-md-2">';
			if (this.imageURL !== undefined) {
				res += '<div class="embed-responsive embed-responsive-1by1">';
				res += '<img src="' + this.imageURL + '" alt="' + this.title + '" class="embed-responsive-item" style="object-fit: cover">';
				res += '</div>';
			} else if (this.imageHTML !== undefined) {
				res += this.imageHTML;
			} else if (this.imageScript !== undefined) {
				res += eval(this.imageScript);
			}
			res += '<div class="card-body px-0 pt-6 pb-4">';
			res += '<div class="card-subtitle mb-1"><a class="text-muted" href="' + this.sec.url + '">' + this.sec.title + '</a></div>';
			if (item.url !== undefined) {
				res += '<h6 class="card-title mb-2">' + this.title + '<a  href="' + this.url + '"' + (getHostName(this.url) === null ? '' : ' target="_blank"') + '><i class="fa ' + (getHostName(this.url) === null ? 'fa-arrow-right' : 'fa-external-link') + ' ml-2"></i></a></h6>';
			}
			res += '<p class="mb-1">' + this.lede + '</p>';
			res += '</div></div>';
			return res;
		}
	}
}

function createRelated(header, cards, orderidxs) {
	var brkColCls = "col-sm-6 col-md-3";
	var res = '<div id="featuredBrowse" class="container mb-5"><section class="pt-4"><h5>' + header + '</h5><div class="row no-gutters mx-n1 mx-md-n2">';
	var ordI = 0;
	var oi = shuffle(orderidxs.slice());
	for (var i = 0; i < cards.length && ordI < oi.length; i++) {
		var card = cards[i];
		res += '<div class="col-6 ' + brkColCls + " order-" + oi[ordI] + '">' + card.createCard() + '</div>';
		ordI++;
	}
	res += '</div></section></div>';
	return res;
}
